# confd variables and funtions
{{- $nodeRole := getv "/host/role" }}
{{- $verticalScalingFlag := "" }}
{{- $changeVxnetFlag := "" }}
{{- $changeVxnetRoles := "" }}
{{- $addingHostsFlag := "" }}
{{- $addingList := "" }}
{{- $deletingHostsFlag := "" }}
{{- $deletingList := "" }}
{{- $tmpval := "" }}

{{- if len (ls "/vertical-scaling-roles") }}
  {{- $verticalScalingFlag = "true" }}
{{- else }}
  {{- $verticalScalingFlag = "false" }}
{{- end }}
{{- if len (ls "/change-vxnet-audit") }}
  {{- $changeVxnetFlag = "true" }}
  {{- $changeVxnetRoles = getv "/change-vxnet-audit/roles" }}
{{- else }}
  {{- $changeVxnetFlag = "false" }}
{{- end }}

{{- $tmpval = "" }}
{{- if len (ls "/adding-hosts") }}
  {{- $addingHostsFlag = "true" }}
  {{- $tmp0 := printf "/adding-hosts/%s" $nodeRole }}
  {{- range lsdir $tmp0 -}}
    {{- $sid := getv (printf "/adding-hosts/%s/%s/sid" $nodeRole .) -}}
    {{- $ip := getv (printf "/adding-hosts/%s/%s/ip" $nodeRole .) -}}
    {{- $tmpval = printf "%s%s/%s " $tmpval $sid $ip }}
  {{- end -}}
  {{- $addingList = $tmpval }}
{{- else }}
  {{- $addingHostsFlag = "false" }}
  {{- $addingList = "" }}
{{- end }}

{{- $tmpval = "" }}
{{- if len (ls "/deleting-hosts") }}
  {{- $deletingHostsFlag = "true" }}
  {{- $tmp0 := printf "/deleting-hosts/%s" $nodeRole }}
  {{- range lsdir $tmp0 -}}
    {{- $sid := getv (printf "/deleting-hosts/%s/%s/sid" $nodeRole .) -}}
    {{- $ip := getv (printf "/deleting-hosts/%s/%s/ip" $nodeRole .) -}}
    {{- $tmpval = printf "%s%s/%s " $tmpval $sid $ip }}
  {{- end -}}
  {{- $deletingList = $tmpval }}
{{- else }}
  {{- $deletingHostsFlag = "false" }}
  {{- $deletingList = "" }}
{{- end }}

# cs_node
{{- $cs_node_list := "" }}
{{- $tmpval = "" }}
{{- range lsdir "/hosts/cs_node" -}}
  {{- $ip := getv (printf "/hosts/cs_node/%s/ip" .) -}}
  {{- $sid := getv (printf "/hosts/cs_node/%s/sid" .) -}}
  {{- $node_id := getv (printf "/hosts/cs_node/%s/node_id" .) -}}
  {{- $tmpval = printf "%s%s/%s/%s " $tmpval $sid $ip $node_id }}
{{- end }}
{{- $cs_node_list = $tmpval }}

# mongos_node
{{- $mongos_node_list := "" }}
{{- $tmpval = "" }}
{{- range lsdir "/hosts/mongos_node" -}}
  {{- $ip := getv (printf "/hosts/mongos_node/%s/ip" .) -}}
  {{- $sid := getv (printf "/hosts/mongos_node/%s/sid" .) -}}
  {{- $node_id := getv (printf "/hosts/mongos_node/%s/node_id" .) -}}
  {{- $tmpval = printf "%s%s/%s/%s " $tmpval $sid $ip $node_id }}
{{- end }}
{{- $mongos_node_list = $tmpval }}

# shard_node
{{- $group_list := "" }}
{{- $tmpval = "" }}
{{- range lsdir "/hosts/shard_node" -}}
  {{- $gid := getv (printf "/hosts/shard_node/%s/gid" .) -}}
  {{- $tmpval = printf "%s%s " $tmpval $gid }}
{{- end }}
{{- $group_list = $tmpval }}
shard_group_list=({{ $group_list }})
{{- $tmpval = "" }}
{{- range lsdir "/hosts/shard_node" -}}
  {{- $gid := getv (printf "/hosts/shard_node/%s/gid" .) -}}
  {{- $ip := getv (printf "/hosts/shard_node/%s/ip" .) -}}
  {{- $sid := getv (printf "/hosts/shard_node/%s/sid" .) -}}
  {{- $node_id := getv (printf "/hosts/shard_node/%s/node_id" .) -}}
  {{- $tmpval = printf "%s%s/%s/%s/%s " $tmpval $sid $ip $node_id $gid }}
  {{- range lsdir "/hosts/shard_node-replica" -}}
    {{- $gid2 := getv (printf "/hosts/shard_node-replica/%s/gid" .) -}}
    {{- $ip2 := getv (printf "/hosts/shard_node-replica/%s/ip" .) -}}
    {{- $sid2 := getv (printf "/hosts/shard_node-replica/%s/sid" .) -}}
    {{- $node_id2 := getv (printf "/hosts/shard_node-replica/%s/node_id" .) -}}
    {{- $tmpval = printf "%s%s/%s/%s/%s " $tmpval $sid2 $ip2 $node_id2 $gid2 }}
  {{- end }}
shard_{{ $gid }}_list=({{ $tmpval}})
encrypted=$(echo -n {{ $node_id }} | sha256sum | base64)
shard_{{ $gid }}_rsname=${encrypted:0:16}
  {{- $tmpval = "" }}
{{- end }}

# cluster
confd_cluster_global_uuid={{ getv "/cluster/global_uuid" }}
confd_cluster_id={{ getv "/cluster/cluster_id" }}
# host
confd_host_sid={{ getv "/host/sid" }}
confd_host_ip={{ getv "/host/ip" }}
confd_host_role={{ $nodeRole }}
# env
confd_env_conf_mongod_engine={{ getv "/env/conf.mongod.engine" }}
confd_env_conf_mongod_port={{ getv "/env/conf.mongod.port" }}
confd_env_db_userpass={{ getv "/env/db.userpass" }}
confd_env_conf_mongod_replication_oplogSizeMB={{ getv "/env/conf.mongod.replication.oplogSizeMB" }}
confd_env_conf_mongod_replication_enableMajorityReadConcern={{ getv "/env/conf.mongod.replication.enableMajorityReadConcern" }}
# cluster hosts
confd_adding_hosts=({{ $addingList }})
confd_deleting_hosts=({{ $deletingList }})
# function
getIp() {
  echo $(echo $1 | cut -d'/' -f2)
}